{% schema %}
{
  "name": "Custom Product Grid",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Tisso vision in the wild"
    },
    {
      "type": "product_list",
      "id": "product_list",
      "label": "Products",
      "limit": 6
    }
  ],
  "presets": [
    {
      "name": "Custom Product Grid"
    }
  ]
}
{% endschema %}

<div class="product-grid">
  <h2 class="product-grid__title">{{ section.settings.title }}</h2>
  
  <div class="product-grid__container">
    {% for product in section.settings.product_list %}
      <div class="product-card" data-product-id="{{ product.id }}">
        <div class="product-card__image-container">
          <img 
            src="{{ product.featured_image | img_url: 'medium' }}"
            alt="{{ product.title }}"
            class="product-card__image"
          >
          <button class="product-card__popup-trigger">+</button>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Product Popup Template -->
<template id="product-popup-template">
  <div class="product-popup">
    <button class="product-popup__close">×</button>
    <div class="product-popup__content">
      <div class="product-popup__image-container">
        <img class="product-popup__image" src="" alt="">
      </div>
      <div class="product-popup__details">
        <h3 class="product-popup__title"></h3>
        <div class="product-popup__price">980,00€</div>
        <p class="product-popup__description">
          This one-piece swimsuit is crafted from jersey featuring an allover micro Monogram motif in relief.
        </p>
        
        <div class="product-popup__variants">
          <div class="product-popup__color-selector">
            <label>Color</label>
            <div class="color-options"></div>
          </div>
          
          <div class="product-popup__size-selector">
            <label>Size</label>
            <select class="size-select">
              <option value="">Choose your size</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
            </select>
          </div>
        </div>
        
        <button class="product-popup__add-to-cart">
          ADD TO CART <span class="arrow">→</span>
        </button>
      </div>
    </div>
  </div>
</template>

<style>
.product-grid {
  padding: 2rem;
}

.product-grid__title {
  text-align: center;
  margin-bottom: 2rem;
}

.product-grid__container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  max-width: 1200px;
  margin: 0 auto;
}

.product-card {
  position: relative;
}

.product-card__image-container {
  position: relative;
  aspect-ratio: 1;
  overflow: hidden;
}

.product-card__image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.product-card__popup-trigger {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  background: white;
  border: none;
  cursor: pointer;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Popup Styles */
.product-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.product-popup__content {
  background: white;
  padding: 2rem;
  max-width: 800px;
  width: 90%;
  position: relative;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
}

.product-popup__close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
}

.product-popup__image {
  width: 100%;
  height: auto;
}

.product-popup__title {
  margin-bottom: 1rem;
}

.product-popup__price {
  font-size: 1.25rem;
  margin-bottom: 1rem;
}

.product-popup__variants {
  margin: 1rem 0;
}

.color-options {
  display: flex;
  gap: 0.5rem;
  margin: 0.5rem 0;
}

.size-select {
  width: 100%;
  padding: 0.5rem;
  margin: 0.5rem 0;
}

.product-popup__add-to-cart {
  width: 100%;
  padding: 1rem;
  background: black;
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

@media (max-width: 768px) {
  .product-grid__container {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .product-popup__content {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
  // Popup functionality
  document.addEventListener('DOMContentLoaded', function() {
    const popupTriggers = document.querySelectorAll('.product-card__popup-trigger');
    const popupTemplate = document.getElementById('product-popup-template');
    
    popupTriggers.forEach(trigger => {
      trigger.addEventListener('click', function() {
        const productCard = this.closest('.product-card');
        const productId = productCard.dataset.productId;
        
        // Create popup
        const popup = popupTemplate.content.cloneNode(true).children[0];
        document.body.appendChild(popup);
        
        // Close popup
        const closeBtn = popup.querySelector('.product-popup__close');
        closeBtn.addEventListener('click', () => popup.remove());
        
        // Add to cart functionality
        const addToCartBtn = popup.querySelector('.product-popup__add-to-cart');
        addToCartBtn.addEventListener('click', function() {
          const selectedSize = popup.querySelector('.size-select').value;
          const selectedColor = popup.querySelector('.color-options .selected')?.dataset.color;
          
          if (!selectedSize || !selectedColor) {
            alert('Please select both size and color');
            return;
          }
          
          // Add to cart logic
          const formData = {
            items: [{
              id: productId,
              quantity: 1,
              properties: {
                Color: selectedColor,
                Size: selectedSize
              }
            }]
          };
          
          // If Black + Medium selected, add Soft Winter Jacket
          if (selectedColor === 'Black' && selectedSize === 'M') {
            formData.items.push({
              id: 'soft-winter-jacket-id', // Replace with actual product ID
              quantity: 1
            });
          }
          
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })
          .then(response => response.json())
          .then(data => {
            // Update cart UI
            popup.remove();
          })
          .catch(error => {
            console.error('Error:', error);
          });
        });
      });
    });
  });
</script>
