{% schema %}
{
  "name": "Product Grid with Popup",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Tisso vision in the wild"
    },
    {
      "type": "product",
      "id": "winter_jacket",
      "label": "Soft Winter Jacket Product (Auto-add for Black/Medium)"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Product Grid with Popup",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}

<style>
@import url('https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&display=swap');

.product-grid {
  padding: 60px 20px;
  max-width: 1440px;
  margin: 0 auto;
  font-family: 'Jost', sans-serif;
}

.product-grid__title {
  font-family: 'Jost', sans-serif;
  font-size: 36px;
  font-weight: 500;
  margin-bottom: 40px;
  text-align: center;
  color: #000;
}

.product-grid__items {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.product-item {
  position: relative;
  overflow: hidden;
  cursor: pointer;
  background: #fff;
  border-radius: 8px;
}

.product-item__image {
  width: 100%;
  height: 500px;
  object-fit: cover;
  transition: transform 0.3s ease;
  display: block;
}

.product-item:hover .product-item__image {
  transform: scale(1.05);
}

.product-item__info {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.8));
  color: white;
  padding: 30px 20px 20px;
  transform: translateY(100%);
  transition: transform 0.3s ease;
}

.product-item:hover .product-item__info {
  transform: translateY(0);
}

.product-item__title {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 8px;
}

.product-item__price {
  font-size: 16px;
  margin-bottom: 15px;
}

.quick-view-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 50px;
  height: 50px;
  background: rgba(255, 255, 255, 0.95);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  z-index: 5;
  opacity: 0;
  visibility: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.product-item:hover .quick-view-button {
  opacity: 1;
  visibility: visible;
}

.quick-view-button:hover {
  background: #FFF544;
  transform: translate(-50%, -50%) scale(1.1);
}

.quick-view-button svg {
  width: 24px;
  height: 24px;
  stroke: #000;
  stroke-width: 2;
}

/* Popup Styles */
.product-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.product-popup-overlay.active {
  display: flex;
  opacity: 1;
  visibility: visible;
}

.product-popup {
  background: #FFFFFF;
  width: 311px;
  height: 447px;
  border-radius: 0;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
  font-family: 'Jost', sans-serif;
  position: relative;
  transform: scale(0.8);
  transition: transform 0.3s ease;
  overflow: visible;
}

.product-popup-overlay.active .product-popup {
  transform: scale(1);
}

.product-popup__header {
  position: relative;
  padding: 0;
  border-bottom: none;
  height: 140px;
}

.product-popup__close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(248, 248, 248, 0.9);
  border: 1.5px solid #000000;
  width: 12px;
  height: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  transition: background 0.3s ease;
  color: #000;
  font-size: 8px;
  transform: rotate(45deg);
}

.product-popup__close::before {
  content: '+';
  transform: rotate(0deg);
}

.product-popup__close:hover {
  background: #f0f0f0;
}

.product-popup__image {
  position: absolute;
  left: 17px;
  top: 36px;
  right: 174px;
  bottom: 271px;
  background-size: cover;
  background-position: center;
}

.product-popup__title {
  position: absolute;
  left: 145px;
  top: 49px;
  right: 30px;
  font-family: 'Jost';
  font-weight: 300;
  font-size: 16px;
  line-height: 120%;
  color: #000000;
  margin: 0;
  padding-right: 0;
}

.product-popup__price {
  position: absolute;
  left: 145px;
  top: 88px;
  font-family: 'Lustria';
  font-weight: 400;
  font-size: 16px;
  line-height: 120%;
  color: #000000;
}

.product-popup__body {
  padding: 0;
  position: relative;
  height: calc(100% - 140px);
}

.product-popup__description {
  position: absolute;
  width: 146px;
  height: 60px;
  left: calc(50% - 146px/2 + 62.5px);
  top: 119px;
  font-family: 'Jost';
  font-weight: 300;
  font-size: 14px;
  line-height: 110%;
  letter-spacing: -0.01em;
  color: #000000;
  margin: 0;
}

.product-popup__variants {
  margin: 0;
  position: absolute;
  top: 122px;
  left: 20px;
  right: 20px;
}

.variant-group {
  margin-bottom: 20px;
  position: relative;
}

.variant-group__label {
  font-family: 'Jost';
  font-weight: 400;
  font-size: 14px;
  line-height: 130%;
  color: #333333;
  margin: 0 0 8px 0;
  text-transform: none;
  letter-spacing: normal;
}

.variant-group__options {
  display: flex;
  gap: 0;
  position: relative;
}

.variant-option {
  padding: 0;
  border: 0.5px solid #000000;
  background: #FFFFFF;
  color: #000000;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Jost';
  font-weight: 400;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: -0.02em;
  text-transform: capitalize;
  border-radius: 0;
  min-width: auto;
  text-align: left;
  height: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.variant-option:first-child {
  width: calc(50% - 1px);
  padding-left: 14px;
  justify-content: flex-start;
}

.variant-option:last-child {
  width: 50%;
  margin-left: -0.5px;
  padding-left: 14px;
  justify-content: flex-start;
}

.variant-option.selected {
  background: #000000;
  color: #FFFFFF;
}

/* Size selector */
.size-selector {
  position: absolute;
  height: 64px;
  left: 20px;
  right: 20px;
  top: 200px;
}

.size-selector__dropdown {
  position: relative;
  width: 100%;
  height: 40px;
  border: 0.5px solid #000000;
  background: #FFFFFF;
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 0 16px;
  box-sizing: border-box;
}

.size-selector__label {
  font-family: 'Jost';
  font-weight: 400;
  font-size: 14px;
  line-height: 130%;
  color: #333333;
  position: absolute;
  top: -18px;
  left: 0;
}

.size-selector__selected {
  font-family: 'Jost';
  font-weight: 400;
  font-size: 16px;
  line-height: 100%;
  letter-spacing: -0.02em;
  color: #000000;
  flex: 1;
}

.size-selector__arrow {
  width: 0;
  height: 0;
  border-left: 4px solid transparent;
  border-right: 4px solid transparent;
  border-top: 6px solid #000000;
  margin-left: 8px;
}

.product-popup__add-to-cart {
  position: absolute;
  width: 271px;
  height: 45px;
  left: 20px;
  bottom: 25px;
  background: #000000;
  border: none;
  font-family: 'Jost';
  font-weight: 400;
  font-size: 16px;
  line-height: 20px;
  text-transform: uppercase;
  color: #FFFFFF;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-sizing: border-box;
}

.product-popup__add-to-cart:hover {
  background: #FFF544;
  color: #000;
}

.product-popup__add-to-cart:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.product-popup__add-to-cart svg {
  width: 18px;
  height: 18px;
}

/* Loading State */
.product-popup__loading {
  display: none;
  text-align: center;
  padding: 40px;
  color: #666;
}

.product-popup__loading.active {
  display: block;
}

/* Responsive Design */
@media screen and (max-width: 968px) {
  .product-grid__items {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .product-item__image {
    height: 400px;
  }
  
  .product-popup {
    width: 95%;
    max-width: 400px;
  }
  
  .product-popup__header,
  .product-popup__body {
    padding: 25px;
  }
  
  .product-popup__title {
    font-size: 24px;
  }
}

@media screen and (max-width: 568px) {
  .product-grid__items {
    grid-template-columns: 1fr;
  }
  
  .product-grid {
    padding: 40px 15px;
  }
  
  .product-grid__title {
    font-size: 28px;
    margin-bottom: 30px;
  }
  
  .product-item__image {
    height: 350px;
  }
  
  .quick-view-button {
    opacity: 1;
    visibility: visible;
    width: 45px;
    height: 45px;
  }
  
  .product-popup {
    width: 98%;
  }
  
  .product-popup__header,
  .product-popup__body {
    padding: 20px;
  }
  
  .product-popup__title {
    font-size: 22px;
  }
  
  .variant-group__options {
    gap: 8px;
  }
  
  .variant-option {
    padding: 10px 15px;
    font-size: 13px;
  }
}
</style>

<div class="product-grid">
  <h2 class="product-grid__title">{{ section.settings.title }}</h2>
  
  <div class="product-grid__items">
    {% for block in section.blocks %}
      {% if block.settings.product != blank %}
        {% assign product = all_products[block.settings.product] %}
        <div class="product-item" 
             data-product-id="{{ product.id }}" 
             data-product-handle="{{ product.handle }}"
             data-block-id="{{ block.id }}">
          
          {% if product.featured_image %}
            <img 
              src="{{ product.featured_image | image_url: width: 700, height: 700, crop: 'center' }}"
              alt="{{ product.title }}"
              class="product-item__image"
              loading="lazy"
            >
          {% else %}
            <div class="product-item__image" style="background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;">
              No Image
            </div>
          {% endif %}
          
          <div class="product-item__info">
            <h3 class="product-item__title">{{ product.title }}</h3>
            <div class="product-item__price">
              {{ product.price | money }}
              {% if product.compare_at_price > product.price %}
                <span style="text-decoration: line-through; opacity: 0.7; margin-left: 8px;">
                  {{ product.compare_at_price | money }}
                </span>
              {% endif %}
            </div>
          </div>
          
          <button class="quick-view-button" aria-label="Quick view {{ product.title }}">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14"/>
            </svg>
          </button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

<!-- Popup Overlay -->
<div class="product-popup-overlay" id="productPopupOverlay">
  <div class="product-popup">
    <!-- Loading State -->
    <div class="product-popup__loading" id="popupLoading">
      Loading product...
    </div>
      <!-- Product Content -->
    <div class="product-popup__content" id="popupContent" style="display: none;">
      <div class="product-popup__header">
        <button class="product-popup__close" aria-label="Close popup"></button>
        <div class="product-popup__image"></div>
        <h3 class="product-popup__title"></h3>
        <div class="product-popup__price"></div>
      </div>
      
      <div class="product-popup__body">
        <div class="product-popup__description"></div>
        <div class="product-popup__variants" id="popupVariants"></div>
        <div class="size-selector">
          <label class="size-selector__label">Size</label>
          <div class="size-selector__dropdown">
            <span class="size-selector__selected">Choose your size</span>
            <div class="size-selector__arrow"></div>
          </div>
        </div>
        <button class="product-popup__add-to-cart">
          ADD TO CART
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  class ProductPopupManager {
    constructor() {
      this.overlay = document.getElementById('productPopupOverlay');
      this.popup = this.overlay.querySelector('.product-popup');
      this.loading = document.getElementById('popupLoading');
      this.content = document.getElementById('popupContent');
      this.closeBtn = this.overlay.querySelector('.product-popup__close');
      this.addToCartBtn = this.overlay.querySelector('.product-popup__add-to-cart');
      this.variantsContainer = document.getElementById('popupVariants');
      
      this.currentProduct = null;
      this.selectedVariant = null;
      this.winterJacketProduct = {{ section.settings.winter_jacket | json }};
      
      this.init();
    }
    
    init() {
      this.bindEvents();
      console.log('ProductPopupManager initialized');
    }
    
    bindEvents() {
      // Quick view button clicks
      document.addEventListener('click', (e) => {
        const quickViewBtn = e.target.closest('.quick-view-button');
        if (quickViewBtn) {
          e.preventDefault();
          e.stopPropagation();
          
          const productItem = quickViewBtn.closest('.product-item');
          if (productItem) {
            const productHandle = productItem.dataset.productHandle;
            console.log('Quick view clicked for:', productHandle);
            this.openProductPopup(productHandle);
          }
        }
      });
      
      // Close popup
      this.closeBtn.addEventListener('click', () => this.closePopup());
      
      // Close on overlay click
      this.overlay.addEventListener('click', (e) => {
        if (e.target === this.overlay) {
          this.closePopup();
        }
      });
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
          this.closePopup();
        }
      });
      
      // Add to cart
      this.addToCartBtn.addEventListener('click', () => this.handleAddToCart());
    }
    
    async openProductPopup(productHandle) {
      if (!productHandle) {
        console.error('No product handle provided');
        return;
      }
      
      this.showLoading();
      this.overlay.classList.add('active');
      
      try {
        console.log('Fetching product:', productHandle);
        const response = await fetch(`/products/${productHandle}.js`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const product = await response.json();
        console.log('Product fetched:', product);
        
        this.currentProduct = product;
        this.selectedVariant = product.variants[0];
        
        this.renderProduct(product);
        this.hideLoading();
        
      } catch (error) {
        console.error('Error fetching product:', error);
        this.hideLoading();
        this.closePopup();
        alert('Sorry, there was an error loading the product. Please try again.');
      }
    }
      renderProduct(product) {
      // Set product info
      this.content.querySelector('.product-popup__title').textContent = product.title;
      this.content.querySelector('.product-popup__price').textContent = this.formatMoney(product.price);
      
      const description = this.content.querySelector('.product-popup__description');
      description.innerHTML = product.description || 'No description available.';
      
      // Set product image
      const imageContainer = this.content.querySelector('.product-popup__image');
      if (product.featured_image) {
        imageContainer.style.backgroundImage = `url(${product.featured_image})`;
      }
      
      // Render variants
      this.renderVariants(product);
      
      // Update add to cart button
      this.updateAddToCartButton();
    }
    
    renderVariants(product) {
      this.variantsContainer.innerHTML = '';
      
      if (!product.variants || product.variants.length <= 1) {
        console.log('No variants to render');
        return;
      }
      
      console.log('Rendering variants for:', product.title);
      console.log('Product options:', product.options);
      
      // Group variants by options
      const optionGroups = {};
      
      product.variants.forEach(variant => {
        variant.options.forEach((option, index) => {
          const optionName = product.options[index];
          if (!optionGroups[optionName]) {
            optionGroups[optionName] = new Set();
          }
          optionGroups[optionName].add(option);
        });
      });
      
      // Create option selectors
      Object.entries(optionGroups).forEach(([optionName, values]) => {
        const group = document.createElement('div');
        group.className = 'variant-group';
        
        const label = document.createElement('label');
        label.className = 'variant-group__label';
        label.textContent = optionName;
        
        const options = document.createElement('div');
        options.className = 'variant-group__options';
        options.dataset.optionName = optionName;
        
        values.forEach(value => {
          const option = document.createElement('button');
          option.className = 'variant-option';
          option.textContent = value;
          option.dataset.value = value;
          option.type = 'button';
          
          option.addEventListener('click', () => this.selectOption(optionName, value, option));
          
          options.appendChild(option);
        });
        
        // Select first option by default
        if (options.firstElementChild) {
          options.firstElementChild.classList.add('selected');
        }
        
        group.appendChild(label);
        group.appendChild(options);
        this.variantsContainer.appendChild(group);
      });
      
      // Update selected variant based on default selections
      this.updateSelectedVariant();
    }
    
    selectOption(optionName, value, clickedElement) {
      // Remove selected class from siblings
      const siblings = clickedElement.parentElement.querySelectorAll('.variant-option');
      siblings.forEach(sibling => sibling.classList.remove('selected'));
      
      // Add selected class to clicked option
      clickedElement.classList.add('selected');
      
      // Update selected variant
      this.updateSelectedVariant();
    }
    
    updateSelectedVariant() {
      if (!this.currentProduct || !this.currentProduct.variants) return;
      
      // Get selected options
      const selectedOptions = [];
      const optionGroups = this.variantsContainer.querySelectorAll('.variant-group__options');
      
      optionGroups.forEach(group => {
        const selected = group.querySelector('.variant-option.selected');
        if (selected) {
          selectedOptions.push(selected.dataset.value);
        }
      });
      
      console.log('Selected options:', selectedOptions);
      
      // Find matching variant
      this.selectedVariant = this.currentProduct.variants.find(variant => {
        return variant.options.every((option, index) => {
          return selectedOptions.length === 0 || selectedOptions[index] === option;
        });
      });
      
      if (!this.selectedVariant) {
        this.selectedVariant = this.currentProduct.variants[0];
      }
      
      console.log('Selected variant:', this.selectedVariant);
      
      // Update price
      this.content.querySelector('.product-popup__price').textContent = 
        this.formatMoney(this.selectedVariant.price);
      
      // Update add to cart button
      this.updateAddToCartButton();
    }
    
    updateAddToCartButton() {
      const btn = this.addToCartBtn;
      
      if (this.selectedVariant && this.selectedVariant.available) {
        btn.disabled = false;
        btn.innerHTML = `
          ADD TO CART
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        `;
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.textContent = 'SOLD OUT';
        btn.style.opacity = '0.6';
      }
    }
    
    async handleAddToCart() {
      if (!this.selectedVariant || !this.selectedVariant.available) {
        console.log('No variant selected or variant unavailable');
        return;
      }
      
      try {
        console.log('Adding to cart:', this.selectedVariant.id);
        
        // Add main product
        await this.addToCart(this.selectedVariant.id, 1);
        
        // Check for winter jacket auto-add logic
        const selectedOptions = [];
        this.variantsContainer.querySelectorAll('.variant-option.selected').forEach(option => {
          selectedOptions.push(option.dataset.value);
        });
        
        if ((selectedOptions.includes('Black') || selectedOptions.includes('Medium')) && this.winterJacketProduct) {
          console.log('Auto-adding winter jacket');
          if (this.winterJacketProduct.variants && this.winterJacketProduct.variants.length > 0) {
            await this.addToCart(this.winterJacketProduct.variants[0].id, 1);
          }
        }
        
        // Close popup and refresh cart
        this.closePopup();
        document.dispatchEvent(new CustomEvent('cart:refresh'));
        
        // Show success message (you can implement a toast here)
        console.log('Product added to cart successfully');
        
      } catch (error) {
        console.error('Error adding to cart:', error);
        alert('Sorry, there was an error adding the product to cart. Please try again.');
      }
    }
    
    async addToCart(variantId, quantity) {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          id: variantId,
          quantity: quantity
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to add to cart: ${errorText}`);
      }
      
      return response.json();
    }
    
    formatMoney(cents) {
      return (cents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD'
      });
    }
    
    showLoading() {
      this.loading.classList.add('active');
      this.content.style.display = 'none';
    }
    
    hideLoading() {
      this.loading.classList.remove('active');
      this.content.style.display = 'block';
    }
    
    closePopup() {
      this.overlay.classList.remove('active');
      document.body.style.overflow = '';
      
      // Reset content after animation
      setTimeout(() => {
        if (!this.overlay.classList.contains('active')) {
          this.variantsContainer.innerHTML = '';
          this.currentProduct = null;
          this.selectedVariant = null;
        }
      }, 300);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new ProductPopupManager();
    });
  } else {
    new ProductPopupManager();
  }
})();
</script>
